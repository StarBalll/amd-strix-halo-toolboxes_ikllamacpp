name: Build ROCm Nightlies (ik_llama.cpp)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free up runner disk space
        run: |
          echo "Before cleanup:" && df -h /
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          docker system prune --all --force
          docker builder prune --all --force
          echo "After cleanup:" && df -h /

      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        run: cd toolboxes && docker build --no-cache -f Dockerfile.rocm7-nightlies-ik-llama -t starballl/amd-strix-halo-toolboxes_ikllamacpp:rocm-nightlies-ik . && docker push starballl/amd-strix-halo-toolboxes_ikllamacpp:rocm-nightlies-ik

      - name: Image digest
        run: echo "Built starballl/amd-strix-halo-toolboxes_ikllamacpp:rocm-nightlies-ik"

name: Build and Push ROCm 7.2 IK Docker Image

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free up runner disk space
        run: |
          echo "Before cleanup:" && df -h /
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          docker system prune --all --force
          docker builder prune --all --force
          echo "After cleanup:" && df -h /

      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push ROCm 7.2 IK image
        run: cd toolboxes && docker build --no-cache -f Dockerfile.rocm-7.2-ik -t starballl/amd-strix-halo-toolboxes_ikllamacpp:rocm7.2-ik . && docker tag starballl/amd-strix-halo-toolboxes_ikllamacpp:rocm7.2-ik starballl/amd-strix-halo-toolboxes_ikllamacpp:latest-ik && docker push starballl/amd-strix-halo-toolboxes_ikllamacpp:rocm7.2-ik && docker push starballl/amd-strix-halo-toolboxes_ikllamacpp:latest-ik

      - name: Image digest
        run: echo "Built image starballl/amd-strix-halo-toolboxes_ikllamacpp:rocm7.2-ik"
